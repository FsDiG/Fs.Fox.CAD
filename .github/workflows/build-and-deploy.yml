name: 构建检查

on:
  push:
    branches:
      - main
      - '**' # 监听所有分支以支持 [build] 标签
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy:
        description: '手动触发'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: windows-latest
    # 简化条件：main 分支、PR 到 main、包含 [build]/[deploy] 或手动触发
    if: |
      github.ref == 'refs/heads/main' ||
      github.base_ref == 'main' ||
      contains(github.event.head_commit.message, '[build]') ||
      contains(github.event.head_commit.message, '[deploy]') ||
      github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        include:
          # AutoCAD 2019 - MSBuild (.NET Framework)
          - project: AutoCAD 2019 And Test
            path: tests/TestAcad2019/TestAcad2019.csproj
            build-tool: msbuild
            output-prefix: AC_2019
          
          # AutoCAD 2025 - dotnet CLI (.NET 8)
          - project: AutoCAD 2025 And Test
            path: tests/TestAcad2025/TestAcad2025.csproj
            build-tool: dotnet
            output-prefix: AC_2025
          
          # ZWCAD 2022 - MSBuild (.NET Framework)
          - project: ZWCAD 2022 And Test
            path: tests/TestZcad2022/TestZcad2022.csproj
            build-tool: msbuild
            output-prefix: ZW_2022
          
          # ZWCAD 2025 - MSBuild (.NET Framework)
          - project: ZWCAD 2025 And Test
            path: tests/TestZcad2025/TestZcad2025.csproj
            build-tool: msbuild
            output-prefix: ZW_2025

    name: Build ${{ matrix.project }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 8
        if: matrix.build-tool == 'dotnet'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup MSBuild
        if: matrix.build-tool == 'msbuild'
        uses: microsoft/setup-msbuild@v2

      # MSBuild 项目（AutoCAD 2019, ZWCAD 2022, ZWCAD 2025）
      - name: Build with MSBuild (Debug & Release)
        if: matrix.build-tool == 'msbuild'
        run: |
          Write-Host "Building ${{ matrix.project }} - Debug..."
          msbuild ${{ matrix.path }} '/t:Restore;Build' `
            /p:OutputPath="..\..\Build\${{ matrix.output-prefix }}_Debug\" `
            /p:Configuration=Debug /p:Platform="Any CPU" /verbosity:minimal
          
          Write-Host "Building ${{ matrix.project }} - Release..."
          msbuild ${{ matrix.path }} '/t:Restore;Build' `
            /p:OutputPath="..\..\Build\${{ matrix.output-prefix }}_Release\" `
            /p:Configuration=Release /p:Platform="Any CPU" /verbosity:minimal
          
          Write-Host "${{ matrix.project }} builds completed."

      # dotnet CLI 项目（AutoCAD 2025）
      - name: Build with dotnet CLI (Debug & Release)
        if: matrix.build-tool == 'dotnet'
        run: |
          Write-Host "Building ${{ matrix.project }} - Debug..."
          dotnet build ${{ matrix.path }} --configuration Debug
          
          Write-Host "Building ${{ matrix.project }} - Release..."
          dotnet build ${{ matrix.path }} --configuration Release
          
          Write-Host "${{ matrix.project }} builds completed."