name: 构建检查

on:
  push:
    branches:
      - main
      - '**' # 监听所有分支以支持 [build] 标签
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy:
        description: '是否执行部署操作'
        required: false
        type: boolean
        default: false

jobs:
  build:
    name: Build All Targets
    runs-on: self-hosted
    # 简化条件：main 分支、PR 到 main、包含 [build]/[deploy] 或手动触发
    if: |
      github.ref == 'refs/heads/main' ||
      github.base_ref == 'main' ||
      contains(github.event.head_commit.message, '[build]') ||
      contains(github.event.head_commit.message, '[deploy]') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v5

      - name: Setup .NET
        uses: actions/setup-dotnet@v5

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build all (Debug & Release)
        run: |
          $buildRoot = "${{ github.workspace }}\Build"
          New-Item -ItemType Directory -Force -Path $buildRoot | Out-Null

          function Build-MSBuild([string]$csproj, [string]$prefix) {
            Write-Host "Building $prefix - Debug..."
            msbuild $csproj '/t:Restore;Build' `
              /p:OutputPath="..\..\Build\${prefix}_Debug\" `
              /p:Configuration=Debug /p:Platform="Any CPU" /verbosity:minimal
            
            Write-Host "Building $prefix - Release..."
            msbuild $csproj '/t:Restore;Build' `
              /p:OutputPath="..\..\Build\${prefix}_Release\" `
              /p:Configuration=Release /p:Platform="Any CPU" /verbosity:minimal
            
            Write-Host "$prefix builds completed."
          }

          function Build-DotNet([string]$csproj, [string]$prefix) {
            Write-Host "Building $prefix - Debug..."
            dotnet build $csproj --configuration Debug
            
            Write-Host "Building $prefix - Release..."
            dotnet build $csproj --configuration Release
            
            Write-Host "$prefix builds completed."
          }

          # AutoCAD2019 - MSBuild (.NET Framework)
          Build-MSBuild "tests/TestAcad2019/TestAcad2019.csproj" "AC_2019"

          # AutoCAD2025 - dotnet CLI (.NET8)
          Build-DotNet "tests/TestAcad2025/TestAcad2025.csproj" "AC_2025"

          # ZWCAD2022 - MSBuild (.NET Framework)
          Build-MSBuild "tests/TestZcad2022/TestZcad2022.csproj" "ZW_2022"

          # ZWCAD2025 - MSBuild (.NET Framework)
          Build-MSBuild "tests/TestZcad2025/TestZcad2025.csproj" "ZW_2025"
